import torch
from torch import tensor

from squadro.evaluators.channels import get_channels
from squadro.evaluators.rl import DeepQLearningEvaluator
from squadro.state import State
from squadro.tests.tools import ML


class TestDeepQLearningEvaluator(ML):
    def get_evaluator(self):
        return DeepQLearningEvaluator(model_path='/tmp/test')

    def test_eval(self):
        """
        Test that the policy probabilities sum to one and that they are zero for finished pieces.
        """
        state = State(advancement=[[1, 8, 3], [1, 2, 4]], cur_player=0)
        p, value = self.evaluator.evaluate(state)
        # self.assertEqual(expected_value, value)
        # print(p, value)
        self.assertAlmostEqual(1., p.sum())
        self.assertEqual(0., p[1])

    def test_cnn_channels(self):
        turn_count = 13
        state = State(advancement=[[1, 8, 3], [1, 5, 4]], cur_player=0,
                      turn_count=turn_count)
        channels = get_channels(state, board_flipping=True)
        expected = [tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 1., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 1., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 1., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [1., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.3333, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.6667, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 1., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.6667, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 1., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 1., 0.],
                            [0., -1., 0., 0., 0.],
                            [-1., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.3750, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.1250, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 1.0000, 0.0000, 0.0000]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.1250, 0.0000],
                            [0.0000, 0.6250, 0.0000, 0.0000, 0.0000],
                            [0.5000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[1., 1., 1., 1., 1.],
                            [1., 1., 1., 1., 1.],
                            [1., 1., 1., 1., 1.],
                            [1., 1., 1., 1., 1.],
                            [1., 1., 1., 1., 1.]]) * turn_count / state.max_moves]
        self.assertEqual(len(expected), len(channels))
        for a, b in zip(expected, channels):
            torch.testing.assert_close(a, b, atol=1e-4, rtol=1e-4)

    def test_cnn_channels_board_flipping(self):
        state = State(advancement=[[1, 8, 3], [1, 5, 4]], cur_player=1)
        channels = get_channels(state, board_flipping=True)
        expected = [tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 1., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 1., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 1., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 1.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 1., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.6667, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.3333, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.6667, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[0., 0., 0., -1., 0.],
                            [0., 0., -1., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 1., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 1., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.5000, 0.0000],
                            [0.0000, 0.0000, 0.6250, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.1250, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.1250, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 1.0000],
                            [0.0000, 0.3750, 0.0000, 0.0000, 0.0000],
                            [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]),
                    tensor([[0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.],
                            [0., 0., 0., 0., 0.]])]
        self.assertEqual(len(expected), len(channels))
        for a, b in zip(expected, channels):
            torch.testing.assert_close(a, b, atol=1e-4, rtol=1e-4)
